<?xml version="1.0" encoding="UTF-8"?>
<mapping-configuration>
<property  supportCover="false" supportDelete="false" extend="{'type':2,'params':['ROLE_CODE','PAGE_CODE','MENU_REF_PAGE_ID','LAYOUT_VERSION']}"/>
<sql namespace="GET_AUTH_LAYOUT_STRUCTURE_SHOW">
<content name="c3874cf3-60b5-435e-b801-472e359367a9" type="select">
SELECT 
  S.REF_ID as ID,
  S.ID as DATA_ID,
  S.REF_CONTAINER,
  S.PAGE_ID,REF_TITLE,
  S.REF_PARENT_ID,
  S.NODE_TYPE,
  S.NODE_ATTR,
  S.COMPONENT_ID,
  S.REF_DATA,
  S.COMPONENT_ATTR_TYPE,
  CASE T.IS_READ WHEN 'R' THEN 1
WHEN 'NR' THEN 2 END AS R_ALLOW,
CASE T.IS_AUTH WHEN 'A' THEN 1
WHEN 'NA' THEN 2 END AS AUTH_ALLOW
FROM SmartOne2_VC.dbo.SMT_SETTING_LAYOUT_STRUCTURE S
LEFT JOIN 
(
  SELECT
 MAX(B.ID) AS ID,
 MAX(B.AUPAST_REF_OBJ_ID) AS AUPAST_REF_OBJ_ID,
 MAX(AUPAST_R_ALLOW) AS AUFU_R_ALLOW,         /*可读*/
 MAX(AUPAST_R_NOT_ALLOW) AS AUFU_R_NOT_ALLOW, /*不可读*/
 MAX(AUPAST_AUTH_ALLOW) AS AUFU_AUTH_ALLOW,         /*可授权*/
 MAX(AUPAST_AUTH_NOT_ALLOW) AS AUFU_AUTH_NOT_ALLOW, /*不可授权*/
 ISNULL(MAX(R_AUFU_WEIGHT),0) AS R_AUFU_WEIGHT,    /* 读权限 值*/
 ISNULL(MAX(R_NOT_AUFU_WEIGHT),0) AS R_NOT_AUFU_WEIGHT, /* 不读权限权值*/
 ISNULL(MAX(AUTH_AUFU_WEIGHT),0) AS AUTH_AUFU_WEIGHT,    /* 授权权值*/
 ISNULL(MAX(AUTH_NOT_AUFU_WEIGHT),0) AS AUTH_NOT_AUFU_WEIGHT, /* 不授权权值*/
 CASE WHEN MAX(B.AUPAST_R_ALLOW) &gt; MAX(B.AUPAST_R_NOT_ALLOW) THEN 'R'
	ELSE 
	CASE WHEN MAX(R_AUFU_WEIGHT) &gt; MAX(R_NOT_AUFU_WEIGHT) THEN 'R'
	ELSE 'NR' END
	END AS IS_READ,
CASE WHEN MAX(B.AUPAST_AUTH_ALLOW) &gt; MAX(B.AUPAST_AUTH_NOT_ALLOW) THEN 'A'
	ELSE 
	CASE WHEN MAX(AUTH_AUFU_WEIGHT) &gt; MAX(AUTH_NOT_AUFU_WEIGHT) THEN 'A'
	ELSE 'NA' END
	END AS IS_AUTH
FROM
(
SELECT 
  PS.ID,
  PS.AUPAST_REF_OBJ_ID,
  PS.AUPAST_R_ALLOW,
  PS.AUPAST_R_NOT_ALLOW,
  PS.AUPAST_AUTH_ALLOW,
  PS.AUPAST_AUTH_NOT_ALLOW,
  CASE PS.AUPAST_R_ALLOW WHEN 1 THEN PS.AUPAST_WEIGHT  END AS R_AUFU_WEIGHT,
  CASE PS.AUPAST_R_NOT_ALLOW WHEN 2 THEN PS.AUPAST_WEIGHT  END AS R_NOT_AUFU_WEIGHT,
  CASE PS.AUPAST_AUTH_ALLOW WHEN 1 THEN PS.AUPAST_WEIGHT  END AS AUTH_AUFU_WEIGHT,
  CASE PS.AUPAST_AUTH_NOT_ALLOW WHEN 2 THEN PS.AUPAST_WEIGHT  END AS AUTH_NOT_AUFU_WEIGHT 
FROM SmartOne2_VC.dbo.SMT_AUTH_PAGE_STRUCT PS WITH (NOLOCK)
LEFT JOIN  SmartOne2_VC.dbo.SMT_AUTH_PERMISSION  P WITH (NOLOCK)
ON P.ID = PS.AUPE_ID  
AND P.AUPE_AUTH_TYPE='menu'
WHERE P.AUPE_REF_OBJ_ID IN (
       SELECT 
       lINK.LEFT_VALUE AS ID
       FROM SMT_BASE.dbo.BASE_DATA_REL lINK
       WHERE lINK.RIGHT_VALUE= $ROLE_CODE$ AND lINK.LEFT_TYPE='USER_ID'
       UNION ALL
       SELECT $ROLE_CODE$ AS ID
     ) and ps.AUPAST_PAGE_ID = $MENU_REF_PAGE_ID$
) B GROUP BY B.AUPAST_REF_OBJ_ID
) T ON S.REF_ID = T.AUPAST_REF_OBJ_ID
WHERE S.PAGE_ID = (SELECT TOP (1) ID FROM SmartOne2_VC.dbo.SMT_SETTING_LAYOUT WITH (NOLOCK) WHERE PAGE_CODE = $PAGE_CODE$ AND VERSION = $LAYOUT_VERSION$)
AND (S.COMPONENT_ATTR_TYPE &lt;&gt; 'columns' OR S.COMPONENT_ATTR_TYPE IS NULL)
</content>
</sql>
<validators>
<validator name="ROLE_CODE"  enableNotNull="true" enableDataType="true"  /> 
<validator name="PAGE_CODE"  enableNotNull="true" enableDataType="true"  /> 
<validator name="MENU_REF_PAGE_ID"  enableNotNull="true" enableDataType="true"  /> 
<validator name="LAYOUT_VERSION"  enableNotNull="true" enableDataType="true"  /> 
</validators>
</mapping-configuration>