<?xml version="1.0" encoding="UTF-8"?>
<mapping-configuration>
<property  supportCover="false" supportDelete="false" extend="{'type':2,'params':['ORG_CODE','ROLE_CODE']}"/>
<sql namespace="GET_USER_BY_ROLE">
<content name="b8145c36-beb8-4e25-baea-c3d987361249" type="select">
WITH DEPT_USER AS
(
 SELECT * FROM (
  SELECT 
   B.ID,
   B.REAL_NAME,
   B.NAME AS NIKE_NAME,
   B.SEX,
   B.PHONE_NUM,
   B.EMAIL,
   C.CODE,
   C.PARENT_ID,
   C.ID AS ORG_ID
  FROM SMT_BASE.dbo.BASE_DATA_REL AS A WITH (NOLOCK)
  INNER JOIN SMT_BASE.dbo.BASE_USER AS B WITH(NOLOCK)
  ON A.LEFT_VALUE = B.ID AND A.LEFT_TYPE='USER_ID'
  INNER JOIN SMT_BASE.dbo.BASE_ORG AS C WITH(NOLOCK)
  ON A.RIGHT_VALUE = C.CODE AMD A.RIGHT_TYPE='ORG_CODE'
  WHERE C.CODE= $ORG_CODE$
 ) AS T
 UNION ALL
 SELECT P.* FROM (
  SELECT 
   B.ID,
   B.REAL_NAME,
   B.NAME AS NIKE_NAME,
   B.SEX,
   B.PHONE_NUM,
   B.EMAIL,
   C.CODE,
   C.PARENT_ID,
   C.ID AS ORG_ID
  FROM SMT_BASE.dbo.BASE_DATA_REL AS A WITH (NOLOCK)
  INNER JOIN SMT_BASE.dbo.BASE_USER AS B WITH(NOLOCK)
  ON A.LEFT_VALUE = B.ID AND A.LEFT_TYPE='USER_ID'
  INNER JOIN SMT_BASE.dbo.BASE_ORG AS C WITH(NOLOCK)
  ON A.RIGHT_VALUE = C.CODE AMD A.RIGHT_TYPE='ORG_CODE'
 ) AS P,DEPT_USER WHERE P.PARENT_ID = DEPT_USER.ORG_ID
)SELECT 
	DEPT_USER.ID, 
	DEPT_USER.REAL_NAME, 
	DEPT_USER.NIKE_NAME, 
	DEPT_USER.SEX, 
	CASE SEX WHEN 1 THEN '男' WHEN 2 THEN '女' END AS SEX_TEXT, 
	DEPT_USER.PHONE_NUM, 
	DEPT_USER.EMAIL, 
	DEPT_USER.CODE, 
	DEPT_USER.PARENT_ID, 
	DEPT_USER.ORG_ID,
	CASE ISNULL(T.LEFT_VALUE,'NULL') WHEN 'NULL' THEN '未拥有'
	  ELSE '已拥有' END AS USER_IDENTI,
	  CASE ISNULL(T.LEFT_VALUE,'NULL') WHEN 'NULL' THEN 2
	  ELSE 1 END AS SORT 
 FROM DEPT_USER
 LEFT JOIN (
	SELECT ID,LEFT_VALUE, RIGHT_VALUE 
	FROM SMT_BASE.dbo.BASE_DATA_REL 
	WHERE RIGHT_VALUE = $ROLE_CODE$ AND RIGHT_TYPE='ROLE_CODE'
) T ON DEPT_USER.ID = T.LEFT_VALUE
</content>
</sql>
<validators>
<validator name="ORG_CODE"  enableNotNull="true" enableDataType="true"  /> 
<validator name="ROLE_CODE"  enableNotNull="true" enableDataType="true"  /> 
</validators>
</mapping-configuration>